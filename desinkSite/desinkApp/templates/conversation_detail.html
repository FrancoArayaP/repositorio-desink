{% load static %}
{% load custom_filters %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Mensajería</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Botones del header */
.header-buttons {
    display: flex;
    gap: 10px;
}

.btn-primary,
.btn-secondary {
    padding: 10px 20px;
    border-radius: 30px;
    border: none;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s ease-in-out;
}

.btn-primary {
    background: var(--color-primary);
    color: var(--color-light);
}

.btn-primary:hover {
    opacity: 0.85;
}

.btn-secondary {
    background: transparent;
    border: 2px solid var(--color-primary);
    color: var(--color-primary);
}

.btn-secondary:hover {
    background: var(--color-primary);
    color: var(--color-light);
}

.btn-primary a,
.btn-secondary a {
    text-decoration: none;
    color: inherit;
}
    :root {
    --color-primary: #6C3FF0;
    --color-secondary: #FF6F61;
    --color-dark: #2A1A47;
    --color-light: #ffffff;
    --color-text: #3A3A3A;
    --gradient-main: linear-gradient(90deg, #3B36E0, #C84D92, #E6A62B);
}

    /* Header */
        header {
            background: white;
            padding: 1rem 5%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #201435;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        nav a {
            text-decoration: none;
            color: #201435;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .header-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn-secondary {
            padding: 0.5rem 1.5rem;
            border: 1px solid #6366f1;
            background: white;
            color: #6366f1;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-primary {
            padding: 0.5rem 1.5rem;
            background: #6636BD;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }
    :root{
      --color-primary:#6C3FF0;
      --gradient: linear-gradient(90deg,#3B36E0 0%,#C84D92 50%,#E6A62B 100%);
    }
    body {
      margin:0;
      font-family: 'Poppins', sans-serif;
      background: var(--gradient);
      min-height:100vh;
      color: #fff;
    }
    header {
      background: rgba(255,255,255,0.06);
      padding: 18px 28px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .chat-layout {
      display:flex;
      gap: 24px;
      max-width:1200px;
      margin: 28px auto;
      background: rgba(255,255,255,0.06);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      height: calc(100vh - 160px);
    }

    .conversations-list {
      width: 33%;
      background: rgba(255,255,255,0.04);
      overflow-y: auto;
      border-right: 1px solid rgba(255,255,255,0.06);
    }
    .conversation-item {
      padding: 16px 18px;
      border-bottom: 1px solid rgba(255,255,255,0.02);
      display:flex;
      gap:12px;
      align-items:center;
      cursor:pointer;
      transition:background .15s;
      color: #fff;
    }
    .conversation-item:hover { background: rgba(255,255,255,0.03); }
    .conv-avatar {
      width:56px; height:56px; border-radius:50%; overflow:hidden;
      flex:0 0 56px; border:3px solid rgba(255,255,255,0.12);
    }
    .conv-avatar img { width:100%; height:100%; object-fit:cover; display:block; }
    .conv-meta h6 { margin:0; font-weight:700; font-size:16px; }
    .conv-meta p { margin:4px 0 0; color: rgba(255,255,255,0.75); font-size:13px; }

    .chat-window {
      width: 67%;
      display:flex;
      flex-direction:column;
      background: rgba(255,255,255,0.02);
    }
    .chat-header {
      padding:18px;
      border-bottom:1px solid rgba(255,255,255,0.03);
      font-weight:700;
      font-size:18px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .chat-messages {
      padding:20px;
      overflow-y:auto;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .message {
      max-width:70%;
      padding:10px 14px;
      border-radius:14px;
      font-size:14px;
      line-height:1.3;
    }
    .message.sent {
      margin-left:auto;
      background: linear-gradient(90deg,#6C3FF0,#8A4BEA);
      color:white;
    }
    .message.received {
      background: rgba(255,255,255,0.95);
      color:#222;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.06);
    }
    .chat-input {
      padding:14px;
      border-top:1px solid rgba(255,255,255,0.03);
      display:flex;
      gap:12px;
      align-items:center;
      background: rgba(255,255,255,0.02);
    }
    .chat-input input[type="text"]{
      flex:1;
      border-radius:22px;
      padding:10px 14px;
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03);
      color: #fff;
    }
    .chat-input button {
      background: var(--color-primary);
      color: #fff;
      border: none;
      padding:10px 18px;
      border-radius:20px;
    }
  </style>
</head>
<body>

<header>
        <div class="logo"><a href="{% url 'index' %}" style="color: black;text-decoration: none;">CODISEÑO</a></div>
        <nav>
            <ul>
                <li><a href="#">Nuestro Propósito</a></li>
                <li><a href="{% url 'buscar_disenadores' %}">Diseñadores</a></li>
                <li><a href="{% url 'buscar_proyectos' %}">Buscar Trabajo</a></li>
            </ul>
        </nav>
        <div class="header-buttons">
            <button class="btn-secondary">
                <a href="{% url 'logout' %}" style="text-decoration: none;">Cerrar Sesión</a>
            </button>
            <button class="btn-primary"><a href="{% url 'disenador' %}" style="text-decoration: none;">Mi Perfil</a></button>
        </div>
    </header>

<main>
  <div class="chat-layout">
    <!-- Conversaciones -->
    <div class="conversations-list">
      {% for conv in conversations %}
        {% with other=conv|other_participant:request.user %}
          <a href="{% url 'conversation_detail' conv.id %}"
             style="text-decoration:none;color:inherit;display:block;">
            <div class="conversation-item">
              <div class="conv-avatar">
                {% if other.profile.photo_url %}
                  <img src="{{ other.profile.photo_url }}">
                {% else %}
                  <img src="{% static 'images/pf_placeholder.png' %}">
                {% endif %}
              </div>
              <div class="conv-meta">
                <h6>{{ other.first_name }} {{ other.last_name }}</h6>
                {% with last=conv.messages.last %}
                  {% if last %}
                    <p>{{ last.sender.first_name }}: {{ last.text|truncatechars:40 }}</p>
                  {% else %}
                    <p>Sin mensajes</p>
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </a>
        {% endwith %}
      {% empty %}
        <p class="p-3">No tienes conversaciones aún.</p>
      {% endfor %}
    </div>

    <!-- Chat -->
    <div class="chat-window">
      {% if conversation %}
        {% with other=conversation|other_participant:request.user %}
        <div class="chat-header">
          {{ other.first_name }} {{ other.last_name }}
        </div>
        {% endwith %}

        <div id="messages" class="chat-messages">
          {% for msg in conversation.messages.all %}
            <div class="message {% if msg.sender == request.user %}sent{% else %}received{% endif %}">
              {{ msg.text }}<br>
              <small style="opacity:.7;font-size:10px;">
                {{ msg.timestamp|date:"H:i d/m" }}
              </small>
            </div>
          {% endfor %}
        </div>

        <form method="POST" class="chat-input">
          {% csrf_token %}
          <input type="text" name="text" placeholder="Escribe un mensaje..." required>
          <button type="submit">Enviar</button>
        </form>

      {% else %}
        <div class="chat-header">Selecciona una conversación</div>
        <div class="chat-messages d-flex align-items-center justify-content-center">
          <p>Elige una conversación a la izquierda</p>
        </div>
      {% endif %}
    </div>

  </div>
</main>

<script>
window.onload = () => {
  const box = document.getElementById("messages");
  if (box) box.scrollTop = box.scrollHeight;
};
</script>
</body>
</html>
